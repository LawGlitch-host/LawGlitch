<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evidence Tracker - Admissible under Indian Evidence Act</title>
    <style>
        /* ======= GENERAL STYLING ======= */
        :root {
            --blood-red: #ff0033;
            --cyber-yellow: #fff200;
            --matte-black: #0d0d0d;
            --slate-grey: #1f1f1f;
            --glass-bg: rgba(13, 13, 13, 0.7);
            --glass-border: rgba(255, 242, 0, 0.2);
            --shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Courier New', monospace;
        }

        body {
            background-color: var(--matte-black);
            color: white;
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }

        /* Futuristic hacker background animation */
        .cyber-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -2;
            background: var(--matte-black);
            overflow: hidden;
        }

        .cyber-bg::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 30%, rgba(255, 0, 51, 0.1), transparent 40%),
                radial-gradient(circle at 80% 70%, rgba(255, 242, 0, 0.1), transparent 40%);
            z-index: -1;
            animation: gradientMove 20s infinite alternate;
        }

        /* Circuit pattern animation */
        .circuit {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                linear-gradient(to right, rgba(255, 242, 0, 0.05) 1px, transparent 1px),
                linear-gradient(to bottom, rgba(255, 242, 0, 0.05) 1px, transparent 1px);
            background-size: 30px 30px;
            animation: circuitMove 60s linear infinite;
        }

        /* Hex pattern animation */
        .hexagons {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(circle at center, transparent 0%, var(--matte-black) 100%),
                url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100' viewBox='0 0 100 100'%3E%3Cpath d='M50 0L100 25V75L50 100L0 75V25L50 0Z' fill='none' stroke='rgba(255, 242, 0, 0.03)' stroke-width='0.5'/%3E%3C/svg%3E");
            background-size: 60px 60px;
            animation: hexMove 120s linear infinite;
        }

        /* Glitch effect */
        @keyframes glitch {
            0% { transform: translate(0); }
            20% { transform: translate(-2px, 2px); }
            40% { transform: translate(-2px, -2px); }
            60% { transform: translate(2px, 2px); }
            80% { transform: translate(2px, -2px); }
            100% { transform: translate(0); }
        }

        .glitch-effect {
            animation: glitch 0.5s infinite alternate;
        }

        @keyframes gradientMove {
            0% { background-position: 0% 0%; }
            100% { background-position: 100% 100%; }
        }

        @keyframes circuitMove {
            0% { background-position: 0 0; }
            100% { background-position: 30px 30px; }
        }

        @keyframes hexMove {
            0% { background-position: 0 0; }
            100% { background-position: 60px 60px; }
        }

        /* Pulse animation for important elements */
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 242, 0, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(255, 242, 0, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 242, 0, 0); }
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .glass-card {
            background: var(--glass-bg);
            backdrop-filter: blur(8px);
            border-radius: 12px;
            border: 1px solid var(--glass-border);
            box-shadow: var(--shadow);
            padding: 20px;
            margin-bottom: 20px;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .glass-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(255, 0, 51, 0.2);
            border-color: var(--blood-red);
        }

        .btn {
            background: var(--blood-red);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 12px 20px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn:hover {
            background: #cc0029;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(255, 0, 51, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: var(--slate-grey);
        }

        .btn-secondary:hover {
            background: #2a2a2a;
            box-shadow: 0 4px 15px rgba(31, 31, 31, 0.4);
        }

        .btn-warning {
            background: var(--cyber-yellow);
            color: var(--matte-black);
        }

        .btn-warning:hover {
            background: #e6da00;
            box-shadow: 0 4px 15px rgba(255, 242, 0, 0.4);
        }

        .btn-danger {
            background: var(--blood-red);
        }

        .btn-danger:hover {
            background: #cc0029;
            box-shadow: 0 4px 15px rgba(255, 0, 51, 0.4);
        }

        /* ======= HEADER STYLING ======= */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            border-bottom: 1px solid rgba(255, 242, 0, 0.2);
            margin-bottom: 20px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo h1 {
            font-size: 24px;
            font-weight: 700;
            background: linear-gradient(90deg, white, var(--cyber-yellow));
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 0 10px rgba(255, 242, 0, 0.3);
            letter-spacing: 2px;
        }

        .logo-icon {
            color: var(--blood-red);
            font-size: 30px;
            filter: drop-shadow(0 0 5px rgba(255, 0, 51, 0.5));
        }

        /* ======= MAIN APP LAYOUT ======= */
        .app-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-top: 20px;
        }

        /* ======= UPLOAD SECTION ======= */
        #upload-section {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .upload-area {
            border: 2px dashed var(--cyber-yellow);
            border-radius: 12px;
            padding: 40px 20px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            background: rgba(31, 31, 31, 0.3);
            position: relative;
            overflow: hidden;
        }

        .upload-area:hover, .upload-area.drag-over {
            border-color: var(--blood-red);
            background: rgba(255, 0, 51, 0.1);
            box-shadow: 0 0 20px rgba(255, 0, 51, 0.2);
        }

        .upload-icon {
            font-size: 48px;
            color: var(--cyber-yellow);
            margin-bottom: 15px;
            filter: drop-shadow(0 0 5px rgba(255, 242, 0, 0.5));
        }

        .upload-input {
            display: none;
        }

        .file-info {
            margin-top: 20px;
            display: none;
        }

        .file-preview {
            max-width: 100%;
            max-height: 300px;
            border-radius: 8px;
            margin-top: 20px;
            display: none;
            box-shadow: var(--shadow);
            border: 1px solid var(--glass-border);
        }

        .file-note {
            width: 100%;
            background: rgba(31, 31, 31, 0.5);
            border: 1px solid var(--glass-border);
            border-radius: 6px;
            padding: 12px;
            color: white;
            margin-top: 15px;
            resize: vertical;
            font-family: 'Courier New', monospace;
        }

        .file-note::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        /* ======= SEARCH SECTION ======= */
        #search-section {
            display: none;
        }

        .search-tools {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .search-input {
            flex: 1;
            background: rgba(31, 31, 31, 0.5);
            border: 1px solid var(--glass-border);
            border-radius: 6px;
            padding: 12px 15px;
            color: white;
            font-size: 16px;
            font-family: 'Courier New', monospace;
        }

        .search-input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .filter-container {
            position: relative;
        }

        .filter-popup {
            position: absolute;
            top: 100%;
            right: 0;
            width: 280px;
            background: var(--slate-grey);
            border-radius: 8px;
            padding: 15px;
            box-shadow: var(--shadow);
            margin-top: 10px;
            z-index: 100;
            display: none;
            border: 1px solid var(--glass-border);
        }

        .filter-section {
            margin-bottom: 15px;
        }

        .filter-section h4 {
            margin-bottom: 8px;
            color: var(--cyber-yellow);
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .filter-options {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .filter-option {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 6px 12px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .filter-option.active {
            background: var(--blood-red);
            color: white;
        }

        .date-inputs {
            display: flex;
            gap: 8px;
        }

        .date-inputs input {
            flex: 1;
            background: rgba(31, 31, 31, 0.5);
            border: 1px solid var(--glass-border);
            border-radius: 4px;
            padding: 8px;
            color: white;
            font-size: 14px;
            font-family: 'Courier New', monospace;
        }

        /* ======= EVIDENCE LIST ======= */
        .evidence-list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 242, 0, 0.1);
        }

        .evidence-list-header h3 {
            font-size: 18px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .list-actions {
            display: flex;
            gap: 8px;
        }

        .evidence-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .evidence-item {
            display: grid;
            grid-template-columns: auto 1fr auto auto;
            gap: 15px;
            align-items: center;
            padding: 12px 15px;
            background: rgba(31, 31, 31, 0.5);
            border-radius: 8px;
            transition: all 0.2s ease;
            border: 1px solid transparent;
        }

        .evidence-item:hover {
            background: rgba(255, 0, 51, 0.1);
            border-color: var(--blood-red);
        }

        .evidence-select {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .evidence-select input {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: var(--blood-red);
        }

        .evidence-details {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .evidence-name {
            font-weight: 600;
            font-size: 16px;
            color: var(--cyber-yellow);
        }

        .evidence-meta {
            display: flex;
            gap: 15px;
            font-size: 12px;
            color: rgba(255, 255, 255, 0.7);
        }

        .evidence-note {
            font-size: 14px;
            margin-top: 5px;
            font-family: 'Courier New', monospace;
        }

        .highlight {
            background-color: var(--cyber-yellow);
            color: var(--matte-black);
            padding: 0 2px;
            border-radius: 2px;
            font-weight: bold;
        }

        .evidence-thumbnail {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 6px;
            background: rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--cyber-yellow);
            font-size: 24px;
            border: 1px solid var(--glass-border);
        }

        .evidence-actions {
            display: flex;
            gap: 8px;
        }

        .action-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .action-btn:hover {
            background: var(--blood-red);
            transform: scale(1.1);
            box-shadow: 0 0 10px rgba(255, 0, 51, 0.5);
        }

        /* ======= MOBILE NAV ======= */
        .mobile-nav {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: var(--slate-grey);
            padding: 15px;
            justify-content: space-around;
            box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            border-top: 1px solid var(--glass-border);
        }

        .nav-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            color: white;
            text-decoration: none;
            opacity: 0.7;
            transition: all 0.2s ease;
        }

        .nav-btn.active {
            opacity: 1;
            color: var(--cyber-yellow);
            text-shadow: 0 0 5px rgba(255, 242, 0, 0.5);
        }

        .nav-icon {
            font-size: 24px;
        }

        .nav-text {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* ======= MODAL STYLING ======= */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
            backdrop-filter: blur(5px);
        }

        .modal.show {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: var(--slate-grey);
            width: 90%;
            max-width: 500px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            overflow: hidden;
            transform: translateY(20px);
            transition: transform 0.3s ease;
            border: 1px solid var(--glass-border);
        }

        .modal.show .modal-content {
            transform: translateY(0);
        }

        .modal-header {
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255, 242, 0, 0.1);
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--cyber-yellow);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .modal-close {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.2s ease;
        }

        .modal-close:hover {
            opacity: 1;
            color: var(--blood-red);
        }

        .modal-body {
            padding: 20px;
            max-height: 70vh;
            overflow-y: auto;
        }

        .modal-footer {
            padding: 15px 20px;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            border-top: 1px solid rgba(255, 242, 0, 0.1);
        }

        .evidence-preview {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }

        .preview-img {
            max-width: 100%;
            max-height: 300px;
            border-radius: 8px;
            border: 1px solid var(--glass-border);
            box-shadow: var(--shadow);
        }

        .preview-audio, .preview-video {
            width: 100%;
            border-radius: 8px;
            border: 1px solid var(--glass-border);
            box-shadow: var(--shadow);
        }

        .preview-info {
            width: 100%;
            background: rgba(31, 31, 31, 0.5);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid var(--glass-border);
            font-family: 'Courier New', monospace;
        }

        .preview-info p {
            margin-bottom: 8px;
        }

        .preview-info strong {
            color: var(--cyber-yellow);
        }

        /* ======= RESPONSIVE STYLING ======= */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }

            .logo h1 {
                font-size: 20px;
            }

            .glass-card {
                padding: 15px;
            }

            .evidence-item {
                grid-template-columns: auto 1fr auto;
            }

            .evidence-actions {
                flex-direction: column;
            }

            .mobile-nav {
                display: flex;
            }

            .app-container {
                padding-bottom: 80px;
            }

            .desktop-menu {
                display: none;
            }
        }

        @media (max-width: 480px) {
            .evidence-item {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            .evidence-thumbnail {
                width: 100%;
                height: 120px;
            }

            .evidence-meta {
                flex-direction: column;
                gap: 5px;
            }

            .upload-area {
                padding: 20px 15px;
            }

            .search-tools {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <!-- Futuristic background animation -->
    <div class="cyber-bg">
        <div class="circuit"></div>
        <div class="hexagons"></div>
    </div>

    <div class="container">
        <header>
            <div class="logo">
                <span class="logo-icon">⚖️</span>
                <h1>Evidence Tracker</h1>
            </div>
            <div class="desktop-menu">
                <button id="menu-btn" class="btn btn-secondary">
                    <span id="menu-icon">☰</span>
                    <span id="menu-text">Menu</span>
                </button>
            </div>
        </header>

        <div class="app-container">
            <!-- Upload Section -->
            <div id="upload-section" class="glass-card">
                <h2>Upload Evidence</h2>
                <div class="upload-area" id="drop-area">
                    <div class="upload-icon">📤</div>
                    <h3>Drag & Drop or Click to Upload</h3>
                    <p>All file types are supported</p>
                    <input type="file" id="file-input" class="upload-input" accept="*/*">
                </div>
                <div class="file-info" id="file-info">
                    <h3 id="file-name">No file selected</h3>
                    <p id="file-details">-</p>
                    <img id="img-preview" class="file-preview" src="" alt="">
                    <audio id="audio-preview" class="file-preview" controls></audio>
                    <video id="video-preview" class="file-preview" controls></video>
                    <textarea id="file-note" class="file-note" placeholder="Add notes about this evidence..." rows="4"></textarea>
                    <div style="display: flex; gap: 10px; margin-top: 15px;">
                        <button id="encrypt-btn" class="btn">
                            <span>🔒</span> Encrypt & Save
                        </button>
                        <button id="cancel-btn" class="btn btn-secondary">
                            <span>✖️</span> Cancel
                        </button>
                    </div>
                </div>
            </div>

            <!-- Search Section -->
            <div id="search-section" class="glass-card">
                <div class="evidence-list-header">
                    <h2>Evidence Files</h2>
                    <div class="list-actions">
                        <button id="select-all-btn" class="btn btn-secondary">Select All</button>
                        <button id="export-btn" class="btn btn-warning">Export</button>
                        <button id="delete-btn" class="btn btn-danger">Delete</button>
                    </div>
                </div>
                <div class="search-tools">
                    <input type="text" class="search-input" id="search-input" placeholder="Search evidence...">
                    <div class="filter-container">
                        <button id="filter-btn" class="btn btn-secondary">
                            <span>🔍</span> Filter
                        </button>
                        <div class="filter-popup" id="filter-popup">
                            <div class="filter-section">
                                <h4>File Type</h4>
                                <div class="filter-options">
                                    <div class="filter-option active" data-type="all">All</div>
                                    <div class="filter-option" data-type="image">Photos</div>
                                    <div class="filter-option" data-type="audio">Audio</div>
                                    <div class="filter-option" data-type="video">Video</div>
                                    <div class="filter-option" data-type="document">Documents</div>
                                    <div class="filter-option" data-type="archive">Archives</div>
                                    <div class="filter-option" data-type="other">Other</div>
                                </div>
                            </div>
                            <div class="filter-section">
                                <h4>Date Range</h4>
                                <div class="date-inputs">
                                    <input type="date" id="filter-date-from" placeholder="From">
                                    <input type="date" id="filter-date-to" placeholder="To">
                                </div>
                            </div>
                            <div style="margin-top: 15px; text-align: right;">
                                <button id="apply-filter-btn" class="btn">Apply</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="evidence-list" id="evidence-list">
                    <!-- Evidence items will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Mobile Navigation -->
        <div class="mobile-nav">
            <a href="#" class="nav-btn active" id="upload-nav">
                <span class="nav-icon">➕</span>
                <span class="nav-text">Upload</span>
            </a>
            <a href="#" class="nav-btn" id="search-nav">
                <span class="nav-icon">🔍</span>
                <span class="nav-text">Search</span>
            </a>
        </div>

        <!-- Preview Modal -->
        <div class="modal" id="preview-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">Evidence Preview</h3>
                    <button class="modal-close" id="close-preview-modal">×</button>
                </div>
                <div class="modal-body">
                    <div class="evidence-preview" id="modal-evidence-preview">
                        <!-- Preview content will be loaded here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" id="close-preview-btn">Close</button>
                    <button class="btn" id="download-evidence-btn">Download</button>
                    <button class="btn btn-warning" id="share-evidence-btn">Share</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main JavaScript -->
    <script>
        // ==========================================
        // UTILITY FUNCTIONS
        // ==========================================
        
        // Simple encryption/decryption functions (for demo purposes)
        const encryptData = (data, key = "EVIDENCE_TRACKER_SECRET_KEY") => {
            // This is a simple XOR encryption for demo purposes
            // In a real app, use CryptoJS or Web Crypto API
            const encrypted = [];
            for (let i = 0; i < data.length; i++) {
                encrypted.push(String.fromCharCode(data.charCodeAt(i) ^ key.charCodeAt(i % key.length)));
            }
            return btoa(encrypted.join(''));
        };

        const decryptData = (encrypted, key = "EVIDENCE_TRACKER_SECRET_KEY") => {
            try {
                const decoded = atob(encrypted);
                const decrypted = [];
                for (let i = 0; i < decoded.length; i++) {
                    decrypted.push(String.fromCharCode(decoded.charCodeAt(i) ^ key.charCodeAt(i % key.length)));
                }
                return decrypted.join('');
            } catch (e) {
                console.error("Decryption failed:", e);
                return null;
            }
        };

        // Format date for display
        const formatDate = (date) => {
            const d = new Date(date);
            return d.toLocaleDateString('en-IN', {
                day: '2-digit',
                month: 'short',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        };

        // Get file type category
        const getFileType = (fileType) => {
            if (!fileType) return 'other';
            
            if (fileType.startsWith('image/')) return 'image';
            if (fileType.startsWith('audio/')) return 'audio';
            if (fileType.startsWith('video/')) return 'video';
            if (fileType.startsWith('text/') || 
                fileType.includes('pdf') || 
                fileType.includes('document') || 
                fileType.includes('msword') || 
                fileType.includes('presentation') || 
                fileType.includes('spreadsheet')) return 'document';
            if (fileType.includes('zip') || 
                fileType.includes('rar') || 
                fileType.includes('tar') || 
                fileType.includes('7z')) return 'archive';
            return 'other';
        };

        // Get file icon based on type
        const getFileIcon = (fileType) => {
            const type = getFileType(fileType);
            switch (type) {
                case 'image': return '🖼️';
                case 'audio': return '🔊';
                case 'video': return '🎬';
                case 'document': 
                    if (fileType.includes('pdf')) return '📄';
                    if (fileType.includes('word')) return '📝';
                    if (fileType.includes('spreadsheet')) return '📊';
                    if (fileType.includes('presentation')) return '📑';
                    return '📄';
                case 'archive': return '🗄️';
                default: return '📁';
            }
        };

        // Helper to convert base64 to Blob
        const base64ToBlob = (base64, contentType) => {
            const byteCharacters = atob(base64.split(',')[1]);
            const byteArrays = [];
            
            for (let offset = 0; offset < byteCharacters.length; offset += 512) {
                const slice = byteCharacters.slice(offset, offset + 512);
                const byteNumbers = new Array(slice.length);
                
                for (let i = 0; i < slice.length; i++) {
                    byteNumbers[i] = slice.charCodeAt(i);
                }
                
                byteArrays.push(new Uint8Array(byteNumbers));
            }
            
            return new Blob(byteArrays, { type: contentType });
        };

        // Download file helper
        const downloadFile = (dataUrl, fileName) => {
            const a = document.createElement('a');
            a.href = dataUrl;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        };

        // Generate a unique ID
        const generateId = () => {
            return Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
        };

        // Highlight search terms in text
        const highlightText = (text, searchTerm) => {
            if (!searchTerm || !text) return text;
            
            const regex = new RegExp(`(${searchTerm})`, 'gi');
            return text.replace(regex, '<span class="highlight">$1</span>');
        };

        // Extract file creation date from EXIF/metadata (if available)
        const extractFileCreationDate = async (file) => {
            try {
                // For images with EXIF data
                if (file.type.startsWith('image/')) {
                    const exifData = await readExifData(file);
                    if (exifData && exifData.DateTimeOriginal) {
                        // Convert EXIF date format to JS Date
                        const exifDateStr = exifData.DateTimeOriginal;
                        const [datePart, timePart] = exifDateStr.split(' ');
                        const [year, month, day] = datePart.split(':');
                        const [hour, minute, second] = timePart.split(':');
                        
                        return new Date(year, month - 1, day, hour, minute, second).toISOString();
                    }
                }
                
                // For video/audio files with metadata
                if (file.type.startsWith('video/') || file.type.startsWith('audio/')) {
                    // This would require a more complex metadata reader
                    // For now, fall back to file.lastModified
                }
                
                // Fallback to file's last modified date or current date
                return file.lastModified ? new Date(file.lastModified).toISOString() : new Date().toISOString();
            } catch (e) {
                console.error("Error extracting creation date:", e);
                return file.lastModified ? new Date(file.lastModified).toISOString() : new Date().toISOString();
            }
        };

        // Read EXIF data from image (simplified for demo)
        const readExifData = (file) => {
            return new Promise((resolve) => {
                // In a real app, use a proper EXIF reader library
                // This is a simplified version for demo purposes
                resolve(null);
            });
        };

        // ==========================================
        // INDEXEDDB STORAGE
        // ==========================================
        
        const dbName = 'EvidenceTrackerDB';
        const dbVersion = 1;
        const storeName = 'evidence';
        
        let db;
        
        const initDB = () => {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(dbName, dbVersion);
                
                request.onerror = (event) => {
                    console.error('Database error:', event.target.error);
                    reject('Database error');
                };
                
                request.onsuccess = (event) => {
                    db = event.target.result;
                    resolve(db);
                };
                
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains(storeName)) {
                        const store = db.createObjectStore(storeName, { keyPath: 'id' });
                        store.createIndex('name', 'name', { unique: false });
                        store.createIndex('date', 'date', { unique: false });
                        store.createIndex('fileType', 'fileType', { unique: false });
                    }
                };
            });
        };
        
        const evidenceStore = {
            getAll: function() {
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction([storeName], 'readonly');
                                        const store = transaction.objectStore(storeName);
                    const request = store.getAll();
                    
                    request.onsuccess = () => {
                        resolve(request.result || []);
                    };
                    
                    request.onerror = (event) => {
                        console.error('Error getting all evidence:', event.target.error);
                        reject(event.target.error);
                    };
                });
            },
            
            add: function(evidence) {
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction([storeName], 'readwrite');
                    const store = transaction.objectStore(storeName);
                    const request = store.add(evidence);
                    
                    request.onsuccess = () => {
                        resolve();
                    };
                    
                    request.onerror = (event) => {
                        console.error('Error adding evidence:', event.target.error);
                        reject(event.target.error);
                    };
                });
            },
            
            update: function(id, updatedEvidence) {
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction([storeName], 'readwrite');
                    const store = transaction.objectStore(storeName);
                    const getRequest = store.get(id);
                    
                    getRequest.onsuccess = () => {
                        const existingEvidence = getRequest.result;
                        if (existingEvidence) {
                            const mergedEvidence = { ...existingEvidence, ...updatedEvidence };
                            const putRequest = store.put(mergedEvidence);
                            
                            putRequest.onsuccess = () => {
                                resolve(true);
                            };
                            
                            putRequest.onerror = (event) => {
                                console.error('Error updating evidence:', event.target.error);
                                reject(event.target.error);
                            };
                        } else {
                            resolve(false);
                        }
                    };
                    
                    getRequest.onerror = (event) => {
                        console.error('Error getting evidence for update:', event.target.error);
                        reject(event.target.error);
                    };
                });
            },
            
            delete: function(id) {
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction([storeName], 'readwrite');
                    const store = transaction.objectStore(storeName);
                    const request = store.delete(id);
                    
                    request.onsuccess = () => {
                        resolve(true);
                    };
                    
                    request.onerror = (event) => {
                        console.error('Error deleting evidence:', event.target.error);
                        reject(event.target.error);
                    };
                });
            },
            
            deleteMultiple: function(ids) {
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction([storeName], 'readwrite');
                    const store = transaction.objectStore(storeName);
                    
                    let completed = 0;
                    let errors = 0;
                    
                    ids.forEach(id => {
                        const request = store.delete(id);
                        
                        request.onsuccess = () => {
                            completed++;
                            if (completed + errors === ids.length) {
                                resolve(completed > 0);
                            }
                        };
                        
                        request.onerror = (event) => {
                            console.error('Error deleting evidence:', event.target.error);
                            errors++;
                            if (completed + errors === ids.length) {
                                resolve(completed > 0);
                            }
                        };
                    });
                });
            },
            
            get: function(id) {
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction([storeName], 'readonly');
                    const store = transaction.objectStore(storeName);
                    const request = store.get(id);
                    
                    request.onsuccess = () => {
                        resolve(request.result);
                    };
                    
                    request.onerror = (event) => {
                        console.error('Error getting evidence:', event.target.error);
                        reject(event.target.error);
                    };
                });
            }
        };

        // ==========================================
        // UI RENDERING
        // ==========================================
        
        // Render evidence list
        const renderEvidenceList = async (searchTerm = '', filters = {}) => {
            const evidenceList = document.getElementById('evidence-list');
            const allEvidence = await evidenceStore.getAll();
            evidenceList.innerHTML = '';
            
            // Apply filters
            let filteredEvidence = allEvidence;
            
            // File type filter
            if (filters.fileType && filters.fileType !== 'all') {
                filteredEvidence = filteredEvidence.filter(item => item.fileType === filters.fileType);
            }
            
            // Date range filter
            if (filters.dateFrom) {
                const fromDate = new Date(filters.dateFrom).getTime();
                filteredEvidence = filteredEvidence.filter(item => new Date(item.date).getTime() >= fromDate);
            }
            
            if (filters.dateTo) {
                const toDate = new Date(filters.dateTo).getTime() + (24 * 60 * 60 * 1000 - 1); // End of day
                filteredEvidence = filteredEvidence.filter(item => new Date(item.date).getTime() <= toDate);
            }
            
            // Search term filter
            if (searchTerm) {
                filteredEvidence = filteredEvidence.filter(item => 
                    item.name.toLowerCase().includes(searchTerm.toLowerCase()) || 
                    (item.note && item.note.toLowerCase().includes(searchTerm.toLowerCase()))
                );
            }
            
            // Sort by date (newest first)
            filteredEvidence.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            // Render each evidence item
            if (filteredEvidence.length === 0) {
                evidenceList.innerHTML = '<div style="text-align:center; padding:20px;">No evidence files found</div>';
                return;
            }
            
            filteredEvidence.forEach(evidence => {
                const evidenceItem = document.createElement('div');
                evidenceItem.className = 'evidence-item';
                evidenceItem.dataset.id = evidence.id;
                
                // Create checkbox for selection
                const selectDiv = document.createElement('div');
                selectDiv.className = 'evidence-select';
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'evidence-checkbox';
                checkbox.dataset.id = evidence.id;
                selectDiv.appendChild(checkbox);
                
                // Create thumbnail
                const thumbnail = document.createElement('div');
                thumbnail.className = 'evidence-thumbnail';
                
                if (evidence.fileType === 'image') {
                    const img = document.createElement('img');
                    img.src = evidence.data;
                    img.alt = evidence.name;
                    img.style.width = '100%';
                    img.style.height = '100%';
                    img.style.objectFit = 'cover';
                    thumbnail.appendChild(img);
                } else {
                    thumbnail.innerHTML = getFileIcon(evidence.type);
                }
                
                // Create details section
                const details = document.createElement('div');
                details.className = 'evidence-details';
                
                const name = document.createElement('div');
                name.className = 'evidence-name';
                name.textContent = evidence.name;
                
                const meta = document.createElement('div');
                meta.className = 'evidence-meta';
                
                const date = document.createElement('span');
                date.textContent = formatDate(evidence.date);
                
                const type = document.createElement('span');
                type.textContent = evidence.type;
                
                meta.appendChild(date);
                meta.appendChild(type);
                
                const note = document.createElement('div');
                note.className = 'evidence-note';
                note.innerHTML = searchTerm && evidence.note ? highlightText(evidence.note, searchTerm) : (evidence.note || 'No notes');
                
                details.appendChild(name);
                details.appendChild(meta);
                details.appendChild(note);
                
                // Create actions
                const actions = document.createElement('div');
                actions.className = 'evidence-actions';
                
                const previewBtn = document.createElement('button');
                previewBtn.className = 'action-btn preview-btn';
                previewBtn.innerHTML = '👁️';
                previewBtn.title = 'Preview';
                previewBtn.dataset.id = evidence.id;
                
                const shareBtn = document.createElement('button');
                shareBtn.className = 'action-btn share-btn';
                shareBtn.innerHTML = '🔗';
                shareBtn.title = 'Share';
                shareBtn.dataset.id = evidence.id;
                
                actions.appendChild(previewBtn);
                actions.appendChild(shareBtn);
                
                // Assemble evidence item
                evidenceItem.appendChild(selectDiv);
                evidenceItem.appendChild(thumbnail);
                evidenceItem.appendChild(details);
                evidenceItem.appendChild(actions);
                
                evidenceList.appendChild(evidenceItem);
            });
            
            // Attach event listeners
            attachEvidenceListeners();
        };
        
        // Show file preview when uploaded
        const showFilePreview = (file) => {
            const fileInfo = document.getElementById('file-info');
            const fileName = document.getElementById('file-name');
            const fileDetails = document.getElementById('file-details');
            const imgPreview = document.getElementById('img-preview');
            const audioPreview = document.getElementById('audio-preview');
            const videoPreview = document.getElementById('video-preview');
            
            // Reset previews
            imgPreview.style.display = 'none';
            audioPreview.style.display = 'none';
            videoPreview.style.display = 'none';
            
            // Show file info
            fileInfo.style.display = 'block';
            fileName.textContent = file.name;
            fileDetails.textContent = `${file.type || 'Unknown type'} - ${Math.round(file.size / 1024)} KB`;
            
            // Show appropriate preview based on file type
            const fileType = getFileType(file.type);
            const reader = new FileReader();
            
            reader.onload = function(e) {
                const result = e.target.result;
                
                switch (fileType) {
                    case 'image':
                        imgPreview.src = result;
                        imgPreview.style.display = 'block';
                        break;
                    case 'audio':
                        audioPreview.src = result;
                        audioPreview.style.display = 'block';
                        break;
                    case 'video':
                        videoPreview.src = result;
                        videoPreview.style.display = 'block';
                        break;
                    default:
                        // For other file types, we'll just show the file info
                        break;
                }
            };
            
            reader.readAsDataURL(file);
        };

        // Show evidence preview in modal
        const showEvidencePreview = async (evidenceId) => {
            const evidence = await evidenceStore.get(evidenceId);
            if (!evidence) return;
            
            const modalPreview = document.getElementById('modal-evidence-preview');
            modalPreview.innerHTML = '';
            
            // Create preview based on file type
            switch (evidence.fileType) {
                case 'image':
                    const img = document.createElement('img');
                    img.src = evidence.data;
                    img.alt = evidence.name;
                    img.className = 'preview-img';
                    modalPreview.appendChild(img);
                    break;
                case 'audio':
                    const audio = document.createElement('audio');
                    audio.src = evidence.data;
                    audio.controls = true;
                    audio.className = 'preview-audio';
                    modalPreview.appendChild(audio);
                    break;
                case 'video':
                    const video = document.createElement('video');
                    video.src = evidence.data;
                    video.controls = true;
                    video.className = 'preview-video';
                    modalPreview.appendChild(video);
                    break;
                default:
                    // For other file types, show download option
                    const downloadNotice = document.createElement('div');
                    downloadNotice.className = 'preview-info';
                    downloadNotice.innerHTML = `
                        <p><strong>File Type:</strong> ${evidence.type || 'Unknown'}</p>
                        <p>This file type cannot be previewed. Please download to view.</p>
                    `;
                    modalPreview.appendChild(downloadNotice);
                    break;
            }
            
            // Add evidence info
            const infoDiv = document.createElement('div');
            infoDiv.className = 'preview-info';
            
            const nameP = document.createElement('p');
            nameP.innerHTML = `<strong>File Name:</strong> ${evidence.name}`;
            
            const dateP = document.createElement('p');
            dateP.innerHTML = `<strong>Date:</strong> ${formatDate(evidence.date)}`;
            
            const typeP = document.createElement('p');
            typeP.innerHTML = `<strong>Type:</strong> ${evidence.type || 'Unknown'}`;
            
            const noteP = document.createElement('p');
            noteP.innerHTML = `<strong>Notes:</strong> ${evidence.note || 'No notes'}`;
            
            infoDiv.appendChild(nameP);
            infoDiv.appendChild(dateP);
            infoDiv.appendChild(typeP);
            infoDiv.appendChild(noteP);
            
            modalPreview.appendChild(infoDiv);
            
            // Set download button data
            const downloadBtn = document.getElementById('download-evidence-btn');
            downloadBtn.dataset.id = evidenceId;
            
            // Set share button data
            const shareBtn = document.getElementById('share-evidence-btn');
            shareBtn.dataset.id = evidenceId;
            
            // Show modal
            const modal = document.getElementById('preview-modal');
            modal.classList.add('show');
        };

        // Share evidence file using Web Share API
        const shareEvidenceFile = async (evidenceId) => {
            try {
                const evidence = await evidenceStore.get(evidenceId);
                if (!evidence) return;
                
                // Convert base64 to Blob
                const blob = base64ToBlob(evidence.data, evidence.type);
                const file = new File([blob], evidence.name, { type: evidence.type });
                
                if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
                    await navigator.share({
                        title: 'Evidence Tracker - Shared Evidence',
                        text: evidence.note || 'Shared evidence from Evidence Tracker',
                        files: [file]
                    });
                } else {
                    // Fallback for browsers that don't support file sharing
                    alert('Native file sharing not supported in this browser. Please use the download option.');
                }
            } catch (err) {
                console.error('Error sharing file:', err);
                alert('Failed to share file. Please try again.');
            }
        };

        // ==========================================
        // EVENT HANDLERS
        // ==========================================
        
        // Initialize DOM elements and event listeners
        const initUI = async () => {
            await initDB();
            
            const dropArea = document.getElementById('drop-area');
            const fileInput = document.getElementById('file-input');
            const encryptBtn = document.getElementById('encrypt-btn');
            const cancelBtn = document.getElementById('cancel-btn');
            const menuBtn = document.getElementById('menu-btn');
            const uploadNav = document.getElementById('upload-nav');
            const searchNav = document.getElementById('search-nav');
            const filterBtn = document.getElementById('filter-btn');
            const applyFilterBtn = document.getElementById('apply-filter-btn');
            const searchInput = document.getElementById('search-input');
            const selectAllBtn = document.getElementById('select-all-btn');
            const exportBtn = document.getElementById('export-btn');
            const deleteBtn = document.getElementById('delete-btn');
            const closePreviewModal = document.getElementById('close-preview-modal');
            const closePreviewBtn = document.getElementById('close-preview-btn');
            const downloadEvidenceBtn = document.getElementById('download-evidence-btn');
            const shareEvidenceBtn = document.getElementById('share-evidence-btn');
            const filterOptions = document.querySelectorAll('.filter-option');
            
            // Set active filter
            filterOptions.forEach(option => {
                option.addEventListener('click', function() {
                    filterOptions.forEach(opt => opt.classList.remove('active'));
                    this.classList.add('active');
                });
            });
            
            // File drag & drop handlers
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, preventDefaults, false);
            });
            
            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            ['dragenter', 'dragover'].forEach(eventName => {
                dropArea.addEventListener(eventName, highlight, false);
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, unhighlight, false);
            });
            
            function highlight() {
                dropArea.classList.add('drag-over');
            }
            
            function unhighlight() {
                dropArea.classList.remove('drag-over');
            }
            
            // File drop handler
            dropArea.addEventListener('drop', handleDrop, false);
            
            function handleDrop(e) {
                const dt = e.dataTransfer;
                const file = dt.files[0];
                
                if (file) {
                    handleFileSelect(file);
                    fileInput.files = dt.files; // Set the file input files
                }
            }
            
            // File input click handler
            dropArea.addEventListener('click', () => {
                fileInput.click();
            });
            
            // File input change handler
            fileInput.addEventListener('change', function() {
                if (this.files.length > 0) {
                    handleFileSelect(this.files[0]);
                }
            });
            
            // Handle file selection - now accepts all file types
            function handleFileSelect(file) {
                showFilePreview(file);
            }
            
            // Encrypt and save button handler
            encryptBtn.addEventListener('click', async function() {
                const fileInput = document.getElementById('file-input');
                const fileNote = document.getElementById('file-note');
                
                if (!fileInput.files.length) {
                    alert('Please select a file to upload.');
                    return;
                }
                
                const file = fileInput.files[0];
                const reader = new FileReader();
                
                reader.onload = async function(e) {
                    const fileData = e.target.result;
                    
                    // Get original creation date from file metadata
                    const creationDate = await extractFileCreationDate(file);
                    
                    // Create evidence object
                    const evidence = {
                        id: generateId(),
                        name: file.name,
                        type: file.type || 'application/octet-stream',
                        fileType: getFileType(file.type),
                        data: fileData,
                        note: fileNote.value || 'No notes provided',
                        date: creationDate,
                        lastModified: Date.now(),
                        encrypted: true
                    };
                    
                    try {
                        // Save to IndexedDB
                        await evidenceStore.add(evidence);
                        
                        // Reset form
                        resetUploadForm();
                        
                        // If in search view, refresh the list
                        if (document.getElementById('search-section').style.display === 'block') {
                            renderEvidenceList();
                        }
                        
                        // Show success message
                        alert('Evidence encrypted and saved successfully!');
                    } catch (err) {
                        console.error('Error saving evidence:', err);
                        alert('Failed to save evidence. Please try again.');
                    }
                };
                
                reader.readAsDataURL(file);
            });
            
            // Cancel button handler
            cancelBtn.addEventListener('click', resetUploadForm);
            
            // Reset upload form
            function resetUploadForm() {
                fileInput.value = '';
                document.getElementById('file-info').style.display = 'none';
                document.getElementById('file-note').value = '';
                document.getElementById('img-preview').style.display = 'none';
                document.getElementById('audio-preview').style.display = 'none';
                document.getElementById('video-preview').style.display = 'none';
            }
            
            // Menu button handler (desktop)
            menuBtn.addEventListener('click', function() {
                const uploadSection = document.getElementById('upload-section');
                const searchSection = document.getElementById('search-section');
                
                if (uploadSection.style.display !== 'none') {
                    // Switch to search view
                    uploadSection.style.display = 'none';
                    searchSection.style.display = 'block';
                    menuBtn.innerHTML = '<span>📁</span> Upload';
                    renderEvidenceList();
                } else {
                    // Switch to upload view
                    uploadSection.style.display = 'flex';
                    searchSection.style.display = 'none';
                    menuBtn.innerHTML = '<span>🔍</span> Search';
                }
            });
            
            // Mobile navigation handlers
            uploadNav.addEventListener('click', function(e) {
                e.preventDefault();
                document.getElementById('upload-section').style.display = 'flex';
                document.getElementById('search-section').style.display = 'none';
                uploadNav.classList.add('active');
                searchNav.classList.remove('active');
            });
            
            searchNav.addEventListener('click', async function(e) {
                e.preventDefault();
                document.getElementById('upload-section').style.display = 'none';
                document.getElementById('search-section').style.display = 'block';
                uploadNav.classList.remove('active');
                searchNav.classList.add('active');
                await renderEvidenceList();
            });
            
            // Filter button handler
            filterBtn.addEventListener('click', function() {
                const filterPopup = document.getElementById('filter-popup');
                filterPopup.style.display = filterPopup.style.display === 'block' ? 'none' : 'block';
            });
            
            // Apply filter button handler
            applyFilterBtn.addEventListener('click', async function() {
                const activeFilter = document.querySelector('.filter-option.active');
                const dateFrom = document.getElementById('filter-date-from').value;
                const dateTo = document.getElementById('filter-date-to').value;
                
                const filters = {
                    fileType: activeFilter.dataset.type,
                    dateFrom: dateFrom,
                    dateTo: dateTo
                };
                
                await renderEvidenceList(searchInput.value, filters);
                document.getElementById('filter-popup').style.display = 'none';
            });
            
            // Search input handler
            searchInput.addEventListener('input', async function() {
                const searchTerm = this.value;
                
                // Get current filters
                const activeFilter = document.querySelector('.filter-option.active');
                const dateFrom = document.getElementById('filter-date-from').value;
                const dateTo = document.getElementById('filter-date-to').value;
                
                const filters = {
                    fileType: activeFilter.dataset.type,
                    dateFrom: dateFrom,
                    dateTo: dateTo
                };
                
                await renderEvidenceList(searchTerm, filters);
            });
            
            // Select all button handler
            selectAllBtn.addEventListener('click', function() {
                const checkboxes = document.querySelectorAll('.evidence-checkbox');
                const allChecked = Array.from(checkboxes).every(cb => cb.checked);
                
                checkboxes.forEach(checkbox => {
                    checkbox.checked = !allChecked;
                });
            });
            
            // Export button handler
            exportBtn.addEventListener('click', async function() {
                const selectedIds = Array.from(document.querySelectorAll('.evidence-checkbox:checked'))
                    .map(checkbox => checkbox.dataset.id);
                
                if (selectedIds.length === 0) {
                    alert('Please select at least one evidence file to export.');
                    return;
                }
                
                // For each selected evidence, create a download
                const selectedEvidence = await Promise.all(selectedIds.map(id => evidenceStore.get(id)));
                
                if (selectedEvidence.length === 1) {
                    // Single file download
                    const evidence = selectedEvidence[0];
                    downloadFile(evidence.data, evidence.name);
                } else {
                    // In a real app, would create a ZIP file here
                    // For this demo, just download them one by one
                    alert(`Downloading ${selectedEvidence.length} files. In a real app, these would be bundled in a ZIP file.`);
                    selectedEvidence.forEach(evidence => {
                        setTimeout(() => {
                            downloadFile(evidence.data, evidence.name);
                        }, 500);
                    });
                }
            });
            
            // Delete button handler
            deleteBtn.addEventListener('click', async function() {
                const selectedIds = Array.from(document.querySelectorAll('.evidence-checkbox:checked'))
                    .map(checkbox => checkbox.dataset.id);
                
                if (selectedIds.length === 0) {
                    alert('Please select at least one evidence file to delete.');
                    return;
                }
                
                if (confirm(`Are you sure you want to delete ${selectedIds.length} evidence file(s)? This action cannot be undone.`)) {
                    try {
                        await evidenceStore.deleteMultiple(selectedIds);
                        await renderEvidenceList();
                    } catch (err) {
                        console.error('Error deleting evidence:', err);
                        alert('Failed to delete evidence. Please try again.');
                    }
                }
            });
            
            // Preview modal close handlers
            closePreviewModal.addEventListener('click', function() {
                document.getElementById('preview-modal').classList.remove('show');
            });
            
            closePreviewBtn.addEventListener('click', function() {
                document.getElementById('preview-modal').classList.remove('show');
            });
            
            // Download evidence handler
            downloadEvidenceBtn.addEventListener('click', async function() {
                const evidenceId = this.dataset.id;
                const evidence = await evidenceStore.get(evidenceId);
                
                if (evidence) {
                    downloadFile(evidence.data, evidence.name);
                }
            });
            
            // Share evidence handler
            shareEvidenceBtn.addEventListener('click', async function() {
                const evidenceId = this.dataset.id;
                await shareEvidenceFile(evidenceId);
            });
            
            // Close modal on background click
            window.addEventListener('click', function(e) {
                const previewModal = document.getElementById('preview-modal');
                
                if (e.target === previewModal) {
                    previewModal.classList.remove('show');
                }
            });
            
            // Close filter popup when clicking elsewhere
            document.addEventListener('click', function(e) {
                const filterPopup = document.getElementById('filter-popup');
                const filterBtn = document.getElementById('filter-btn');
                
                if (filterPopup.style.display === 'block' && 
                    !filterPopup.contains(e.target) && 
                    e.target !== filterBtn && 
                    !filterBtn.contains(e.target)) {
                    filterPopup.style.display = 'none';
                }
            });
        };

        // Attach event listeners to rendered evidence list items
        const attachEvidenceListeners = () => {
            // Preview button listeners
            document.querySelectorAll('.preview-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const evidenceId = this.dataset.id;
                    showEvidencePreview(evidenceId);
                });
            });
            
            // Share button listeners
            document.querySelectorAll('.share-btn').forEach(btn => {
                btn.addEventListener('click', async function() {
                    const evidenceId = this.dataset.id;
                    await shareEvidenceFile(evidenceId);
                });
            });
        };

        // ==========================================
        // APPLICATION INITIALIZATION
        // ==========================================
        
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize UI and event listeners
            initUI();
            
            // Default to upload view
            document.getElementById('upload-section').style.display = 'flex';
            document.getElementById('search-section').style.display = 'none';
        });
    </script>
</body>
</html>
